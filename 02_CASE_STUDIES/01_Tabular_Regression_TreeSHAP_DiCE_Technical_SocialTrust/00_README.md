## 1) Context
This case study belongs to the *CASE_STUDIES* collection and constitutes the **first pilot** of the *XAI-TrustFramework* empirical validation.  
It combines **TreeSHAP** (attributive reasoning) and **DiCE** (counterfactual reasoning) to assess whether the *theoretical trust properties* of both techniques hold in practice when applied to a **clinical regression model**.

---

## 2) Research Focus

> **To what extent do the explanations generated by TreeSHAP and DiCE preserve their theoretical guarantees of fidelity, completeness, stability, and actionability when applied to a clinical regression model, and how can these properties jointly inform the technical and social dimensions of trust?**

---

## 3) Objective

This pilot uses the open clinical dataset `sklearn.diabetes` to demonstrate that:
- The **technical guarantees** of TreeSHAP (*local accuracy*, *consistency*, *missingness*)  
  can be empirically validated through *fidelity*, *completeness*, and *stability* metrics.  
- The **human-centered guarantees** of DiCE (*proximity*, *feasibility*, *diversity*)  
  can be operationalized through *actionability* and *plausibility* metrics.  

Together, they provide a combined view of **trustworthiness** that connects *model reliability* (technical trust) with *human interpretability and empowerment* (social trust).

---

## 4) Experimental Setup

| Component | Description |
|---|---|
| **Data Type** | Tabular (clinical data) |
| **Task Type** | Regression |
| **Base Model** | `RandomForestRegressor` |
| **XAI Techniques** | `TreeSHAP` (attributive) + `DiCE` (counterfactual) |
| **Trust Notions** | Fidelity, Completeness, Stability, Actionability, Diversity, Plausibility |
| **Trust Dimensions** | Technical + Social |

### Configuration and Reproducibility Setup

This notebook is fully parameterized through external configuration files located in `configs/`, ensuring transparent and reproducible experimentation.  
Instead of defining parameters within the notebook, all methodological settings are declared in YAML/JSON files:

| File | Purpose |
|------|----------|
| `configs/priors_clinical.yaml` | Defines clinical priors, tolerance thresholds (τ), and perturbation noise (ε) for technical metrics (completeness, stability). |
| `configs/dice_constraints.yaml` | Specifies immutable variables, feature bounds, and DiCE generation parameters for social trust metrics (actionability, diversity, plausibility). |
| `configs/seeds.json` | Ensures reproducibility across data splits, model training, and perturbations. |

The notebook automatically loads these configurations at runtime and applies them consistently across:
- **Data splitting** (train/validation/test)
- **Model training** (RandomForest baseline)
- **XAI evaluation metrics** (fidelity, completeness, stability)
- **Counterfactual generation** (DiCE)

> Any methodological change—such as adjusting tolerance thresholds, bounds, or immutables—must be done by editing these YAML/JSON files in the repository.  
> This guarantees experiment reproducibility, transparency, and traceability for peer validation.

**Workflow**

```
01_Tabular_Regression_TreeSHAP_DiCE_Technical_SocialTrust/
├── notebooks/
│ ├── Tabular_Regression_TreeSHAP_DiCE_Technical_SocialTrust.ipynb
├── results/
│ ├── metrics_summary.csv
│ ├── stability_analysis.csv
│ ├── dice_counterfactuals.csv
│ └── visuals/
└── configs/
│├── priors_clinical.yaml
│├── dice_constraints.yaml
│└── seeds.json
```


---

## 5) Metrics Operationalized

| Metric | Definition (operational) | Technique | Theoretical Link | Trust Dimension |
|---------|---------------------------|------------|------------------|-----------------|
| **Fidelity** | Agreement between model prediction `f(x)` and additive reconstruction `φ₀ + Σφᵢ(x)` (MAE / R²). | TreeSHAP | Local accuracy | Technical |
| **Completeness** | Percentage of instances where `abs(f(x) - (φ₀ + Σφᵢ(x))) ≤ τ`. | TreeSHAP | Additivity / Missingness | Technical |
| **Stability** | Robustness of SHAP vectors under ε-perturbations (cosine / Spearman). | TreeSHAP | Consistency | Technical |
| **Actionability** | Share of counterfactuals meeting domain constraints and reaching target. | DiCE | Proximity / Feasibility | Social |
| **Diversity** | Mean pairwise distance between CFs (L1/L2) per instance. | DiCE | Diversity | Social |
| **Plausibility** | Share of CFs within clinically plausible ranges (from `dice_constraints.yaml`). | DiCE | Feasibility | Social |

> **Note:** Thresholds (`τ` for completeness, `ε` for perturbations, clinical bounds) are set in `configs/` and should be reported alongside scores.

---

## 6) Results (to be populated from `results/*.csv`)

> **Status:** No result CSVs found in this workspace yet.  
> Once you run `04_METRICS_EVALUATION.ipynb`, export the following files and re-render this README to auto-fill the table.

### 6.1 Summary Metrics

| Metric | Technique | Score | 95% CI | Notes |
|---|---|---|---|---|
| Fidelity (R²) | TreeSHAP | TBD | TBD | Validation split |
| Completeness (%) | TreeSHAP | TBD | – | τ = TBD |
| Stability (cosine↑) | TreeSHAP | TBD | [TBD, TBD] | ε = TBD |
| Actionability (%) | DiCE | TBD | – | target band = TBD |
| Diversity (mean dist) | DiCE | TBD | – | metric = L1/L2 |
| Plausibility (%) | DiCE | TBD | – | constraints: `dice_constraints.yaml` |

### 6.2 Stability Analysis (instance-level)

Expected columns in `results/stability_analysis.csv`:  
`instance_id, cosine_similarity, spearman_rho, l2_drift`

### 6.3 Counterfactuals (per instance)

Expected columns in `results/dice_counterfactuals.csv`:  
`instance_id, cf_id, proximity, feasible, plausible, diversity_contrib, details`

---

## 7) Interpretation by User Profile

### 7.1 Clinical profile (healthcare team)
**Decision task.** Validate whether the model’s recommendation and its explanation are **reliable and clinically sound**.  
**Signals to check.**
- **Fidelity / Completeness:** high agreement between additive reconstruction and `f(x)`; residuals within clinical tolerance τ.
- **Stability:** small ε-perturbations (measurement noise) do not flip the explanation ranking.
- **Plausibility:** CFs respect immutable features and clinical bounds; interventions map to real levers (e.g., dosage, schedule, diet).

**Acceptance criteria (example):**
- Completeness ≥ 95% with τ ≤ 1.0 mmol/L (or domain-specific tolerance).
- Median cosine similarity ≥ 0.9 under ε-perturbations within sensor noise.
- ≥ 80% of CFs flagged as *plausible* by constraints and clinical priors.

**Clinician-facing explanation (template):**
> “This prediction is primarily driven by **BMI** (+0.42), **baseline glucose** (+0.31) and **age** (+0.12).  
> The explanation reconstructs the model within **±0.8** mmol/L (completeness ✓).  
> Under small input variation, feature attributions remain stable (median cosine **0.92**).  
> Feasible adjustments suggest **[feature Δ]** would reduce predicted glucose by **Δy** within safe bounds.”

---

### 7.2 Patient profile (self-management)
**Decision task.** Understand **what you can do** and **why** the system suggests it.  
**Signals to check.**
- **Actionability:** suggested changes are clear and doable in daily life.
- **Clarity:** top-3 drivers shown in simple terms; avoid clinical jargon.
- **Diversity:** more than one valid option to reach the target.

**Patient-facing explanation (template):**
> “Tu resultado viene sobre todo de **[factor 1]**, **[factor 2]** y **[factor 3]**.  
> Para mejorar, puedes elegir una de estas opciones:  
> 1) **[Cambio A]** (cambio pequeño, fácil de aplicar),  
> 2) **[Cambio B]** (requiere aprobación médica),  
> 3) **[Cambio C]** (opción alternativa si A/B no encajan).  
> El sistema propone opciones realistas para tu caso.”

> **Safety note.** Las recomendaciones que impliquen medicación o cambios de tratamiento **deben** ser validadas por el equipo clínico.

---

## 8) How TreeSHAP and DiCE Complement Each Other

| Aspect | TreeSHAP (Attributive) | DiCE (Counterfactual) |
|---|---|---|
| **Explains** | *Why* a prediction was made | *What needs to change* for a different outcome |
| **Trust Type** | Internal reliability | Human actionability |
| **Metric Focus** | Fidelity, Completeness, Stability | Actionability, Diversity, Plausibility |
| **Dimension** | Technical | Social |
| **Interaction** | TreeSHAP provides a baseline for model coherence; DiCE tests if explanations translate into meaningful actions. |

---

## 9) Reproducibility — Run & Export

1. Run the notebook end-to-end:  
   `Tabular_Regression_TreeSHAP_DiCE_Technical_SocialTrust (3).ipynb`
2. Ensure the evaluation step writes:
   - `results/metrics_summary.csv`
   - `results/stability_analysis.csv`
   - `results/dice_counterfactuals.csv`
3. Re-render this README (or run the small utility below) to auto-fill tables from CSVs.


